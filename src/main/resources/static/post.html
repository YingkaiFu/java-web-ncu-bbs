<!doctype html>
<html lang="zh-Hans">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <link rel="stylesheet" href="css/bootstrap.css">
        <link rel="stylesheet" href="css/bootstrap-theme.css">
        <link rel="stylesheet" href="css/common.css">
        <title>å¸–å­</title>
    </head>
    <body>
        <!-- æ¸²æŸ“é¡¶éƒ¨å¯¼èˆªæ  -->
        <script src="js/jquery-3.3.1.js"></script>
        <script src="js/header.js"></script>
        <script src="js/common.js"></script>
        <div class="container">
            <script>
                let themeId = getQueryString("themeId");

                $.ajax({
                    url: "/theme/getThemeById?themeId=" + themeId,
                    type: "get",
                    contentType: "application/json",
                    success: function (response) {
                        theme = response;
                        $.ajax({
                            type: "get",
                            url: "/post/getPostsByThemeId?themeId=" + themeId,
                            contentType: "application/json",
                            success: function (response) {
                                console.log(response);
                                for (let i = 0; i < response.length; i++) {
                                    let post = response[i];
                                    console.log();
                                    $("#postList").append(
                                        '<div class="row list-group-item">' +
                                        '<div class="col-lg-3">' +
                                        '<div style="text-align: center;">' +
                                        '<a href="user-page.html?accountId=' + post.authorId + '">' +
                                        '<img src="/img/200x200.jpg" class="img-circle" title="netuxi">' +
                                        '</a>' +
                                        '<p class="h3">' + post.nickName + '</p>' +
                                        '</div>' +
                                        '</div>' +
                                        '<div class="col-lg-9" style="border-left-width: 1px; border-left-style: solid; border-left-color: #dddddd;">' +
                                        (post.replyId != null ?
                                            '<div style="border-left-width: 5px; padding-left: 5px; border-left-style: solid; border-left-color: antiquewhite;">' +
                                            '<span>ç½—ä¼Ÿåœ¨ä»–çš„å¸–å­ä¸­æåˆ°ï¼š</span>' +
                                            '<div>' +
                                            '<h3>é”¤å­ç§‘æŠ€è¢«ç”³è¯·è´¢äº§ä¿å…¨</h3>' +
                                            '<p>12 æœˆ 26 æ—¥ï¼Œæœ‰ç½‘å‹æ›å‡ºç½—æ°¸æµ©å·²æ­£å¼å¸ä»»é”¤å­ç§‘æŠ€å­å…¬å¸æˆéƒ½é‡æœ›æ•°ç ç§‘æŠ€æœ‰é™å…¬å¸æ³•å®šä»£è¡¨äººã€‚</p>' +
                                            '</div>' +
                                            '</div>' : "") +
                                        '<div style="border-bottom: rebeccapurple solid 1px;">' + post.content + '</div>' +
                                        '<div>' +
                                        '<button type="button" class="btn reply-button" data-reply-id="' + post.id + '">' +
                                        '<span class="glyphicon glyphicon-edit" aria-hidden="true"></span>å›å¸–' +
                                        '</button>' +
                                        '</div>' +
                                        '</div>' +
                                        '</div>'
                                    );
                                }
                            }
                        });
                    }
                });



            </script>
            <div class="row">
                <div class="col-lg-12">
                    <!-- å¯¼èˆªè·¯å¾„ -->
                    <ol class="breadcrumb">
                        <li><a href="index.html">é¦–é¡µ</a></li>
                        <li><a href="setions.html">ç‰ˆå—åˆ†åŒº</a></li>
                    </ol>
                </div>
            </div>

            <!-- å¸–å­åˆ—è¡¨ -->
            <div class="row">
                <!-- å¸–å­åˆ—è¡¨ -->
                <div class="col-lg-12">
                    <div class="list-group" id="postList">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8 col-lg-offset-2">
                    <h3>å‘å¸–åæ§½ä¸€ä¸‹</h3>
                    <div id="post-editor"></div>
                    <button class="btn btn-default btn-block success" type="button" role="button" id="create-post">å‘å¸–</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€æ¡† -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">å›å¸–</h4>
                    </div>
                    <div class="modal-body" id="editor"></div>
                    <div style="display: none" value="1" id="reply-id">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" id="post-send-button">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸²æŸ“åº•éƒ¨ç‰ˆæƒå£°æ˜ -->
        <script src="js/footer.js"></script>
        <script src="js/jquery-3.3.1.js"></script>
        <script src="js/bootstrap.js"></script>
        <script src="js/wangEditor.js"></script>
        <script>
            // å£°æ˜åˆ›å»ºå¯Œæ–‡æœ¬ç¼–è¾‘å™¨
            let E = window.wangEditor;
            let editor = new E("#editor");
            editor.customConfig.emotions = [
                {
                    title: 'emoji',
                    type: 'emoji',
                    content: ['ğŸ˜','ğŸ˜‚','ğŸ˜ƒ','ğŸ˜„','ğŸ˜…','ğŸ˜†','ğŸ˜‰','ğŸ˜Š','ğŸ˜‹','ğŸ˜','ğŸ˜’','ğŸ˜“','ğŸ˜”','ğŸ˜–','ğŸ˜˜','ğŸ˜š','ğŸ˜œ','ğŸ˜','ğŸ˜',
                        'ğŸ˜ ','ğŸ˜¡','ğŸ˜¢','ğŸ˜£','ğŸ˜¤','ğŸ˜¥','ğŸ˜¨','ğŸ˜©','ğŸ˜ª','ğŸ˜«','ğŸ˜­','ğŸ˜°','ğŸ˜±','ğŸ˜²','ğŸ˜³','ğŸ˜µ','ğŸ˜·','ğŸ˜¸','ğŸ˜¹','ğŸ˜º',
                        'ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ˜¾','ğŸ˜¿','ğŸ™€','ğŸ™…','ğŸ™†','ğŸ™‡','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ™‹','ğŸ™Œ','ğŸ™','ğŸ™','ğŸ™']
                }
            ];
            editor.create();

            // å‘å¸–ç¼–è¾‘å™¨
            let postEditor = new E("#post-editor");
            postEditor.customConfig.emotions = [
                {
                    title: 'emoji',
                    type: 'emoji',
                    content: ['ğŸ˜','ğŸ˜‚','ğŸ˜ƒ','ğŸ˜„','ğŸ˜…','ğŸ˜†','ğŸ˜‰','ğŸ˜Š','ğŸ˜‹','ğŸ˜','ğŸ˜’','ğŸ˜“','ğŸ˜”','ğŸ˜–','ğŸ˜˜','ğŸ˜š','ğŸ˜œ','ğŸ˜','ğŸ˜',
                        'ğŸ˜ ','ğŸ˜¡','ğŸ˜¢','ğŸ˜£','ğŸ˜¤','ğŸ˜¥','ğŸ˜¨','ğŸ˜©','ğŸ˜ª','ğŸ˜«','ğŸ˜­','ğŸ˜°','ğŸ˜±','ğŸ˜²','ğŸ˜³','ğŸ˜µ','ğŸ˜·','ğŸ˜¸','ğŸ˜¹','ğŸ˜º',
                        'ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ˜¾','ğŸ˜¿','ğŸ™€','ğŸ™…','ğŸ™†','ğŸ™‡','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ™‹','ğŸ™Œ','ğŸ™','ğŸ™','ğŸ™']
                }
            ];
            postEditor.create();

            // åœ¨ä¸»é¢˜ä¸‹å‘å¸–
            $("#create-post").click(function () {
                // åœ¨ä¸»é¢˜ä¸‹å‘é€å¸–å­ï¼Œé¦–å…ˆéœ€è¦è·å¾—ä¸»é¢˜ID
                let authorId = JSON.parse(localStorage.getItem("user")).userAccountId;
                let setionId = theme.setionId;
                let postThemeId = theme.id;
                let content = postEditor.txt.html();
                $.ajax({
                    url: "/post/addPost",
                    type: "post",
                    data: JSON.stringify({
                        authorId: authorId,
                        setionId: setionId,
                        postThemeId: postThemeId,
                        content: content
                    }),
                    dataType: "json",
                    contentType: "application/json",
                    success: function (response) {
                        alert("åˆ›å»ºæˆåŠŸ");
                        $("#postList").append(
                            '<div class="row list-group-item">' +
                                '<div class="col-lg-3">' +
                                    '<div style="text-align: center;">' +
                                        '<p class="text-right" style="height: 0;">' +
                                            '<span style="font-size: 25px; background-color: cornflowerblue; color: white; width: 60px; display: inline-block; text-align: center; border-radius: 5px; ">' + (theme.authorAccountId === JSON.parse(localStorage.getItem("user")).userAccountId? "æ¥¼ä¸»" : "è®¿å®¢") + '</span>' +
                                        '</p>' +
                                        '<a href="user-page.html?accountId=' + JSON.parse(localStorage.getItem("user")).userAccountId + '">' +
                                            '<img src="/img/200x200.jpg" class="img-circle" title="netuxi">' +
                                        '</a>' +
                                    '<p class="h3">' + JSON.parse(localStorage.getItem("user")).nickname + '</p>' +
                            '</div>' +
                            '</div>' +
                            '<div class="col-lg-9" style="border-left-width: 1px; border-left-style: solid; border-left-color: #dddddd;">' +
                            '<div style="border-bottom: rebeccapurple solid 1px;">' + content + '</div>' +
                            '<div>' +
                            '<button type="button" class="btn" data-toggle="modal" data-target="#myModal">' +
                            '<span class="glyphicon glyphicon-edit" aria-hidden="true"></span>å›å¸–' +
                            '</button>' +
                            '</div>' +
                            '</div>' +
                            '</div>');
                    },
                    error: function (response) {
                        alert("å‘é€å¸–å­æˆåŠŸå•¦");
                        $("#postList").append('<div class="row list-group-item">' +
                            '<div class="col-lg-3">' +
                                '<div style="text-align: center;">' +
                                    '<p class="text-right" style="height: 0;">' +
                                        '<span style="font-size: 25px; background-color: cornflowerblue; color: white; width: 60px; display: inline-block; text-align: center; border-radius: 5px; ">' + (theme.authorAccountId === post.authorId ? "æ¥¼ä¸»" : "è®¿å®¢") + '</span>' +
                                    '</p>' +
                                    '<a href="user-page.html?accountId=' + post.authorId + '">' +
                                        '<img src="/img/200x200.jpg" class="img-circle" title="netuxi">' +
                                    '</a>' +
                                    '<p class="h3">' + JSON.parse(localStorage.getItem("user")).nickname + '</p>' +
                                '</div>' +
                            '</div>' +
                            '<div class="col-lg-9" style="border-left-width: 1px; border-left-style: solid; border-left-color: #dddddd;">' +
                                '<div style="border-bottom: rebeccapurple solid 1px;">' + content + '</div>' +
                                    '<div>' +
                                        '<!--button type="button" class="btn" data-toggle="modal" data-target="#myModal">' +
                                            '<span class="glyphicon glyphicon-edit" aria-hidden="true"></span>å›å¸–' +
                                        '</button-->' +
                                    '</div>' +
                                '</div>' +
                            '</div>'
                        );
                    }
                });
            });

            // å‘é€å›å¤å¸–
            $("#postList").on("click", ".reply-button", function () {
                $("#myModal").modal();
                // console.log($(this).parent().attr("data-reply-id"));
                // æ‰€è¦å›å¤å¸–å­çš„ID
                let replyId = $($(this).parent().html()).attr("data-reply-id");
                // æ‰€è¦å›å¤å¸–å­çš„å†…å®¹
                console.log($(this).parent().parent().html());
                let toContent = $(this).parent().parent().find("div:first-child").html();
                console.log(replyId);
                console.log($("#reply-id").attr("value", replyId));
                $("#reply-id").html(toContent);
            })

            $("#myModal").on("click", "#post-send-button", function () {
                let content = editor.txt.html();
                let authorId = JSON.parse(localStorage.getItem("user")).userAccountId;
                let setionId = theme.setionId;
                let postThemeId = theme.id;
                $.ajax({
                    url: "/post/addPost",
                    type: "post",
                    contentType: "application/json",
                    data: JSON.stringify({
                        content: content,
                        authorId: authorId,
                        setionId: setionId,
                        postThemeId: postThemeId
                    }),
                    success: function (response) {
                        console.log(response);
                        alert("æˆåŠŸå“ˆå“ˆ!");
                        let toContent = $("#reply-id").html();
                        console.log("æ‰€è¦å›å¤å¸–å­çš„å†…å®¹");
                        console.log(toContent);
                        $("#postList").append(
                            '<div class="row list-group-item">' +
                                '<div class="col-lg-3">' +
                                    '<div style="text-align: center;">' +
                                        '<a href="user-page.html?accountId=' + post.authorId + '">' +
                                            '<img src="/img/200x200.jpg" class="img-circle" title="netuxi">' +
                                        '</a>' +
                                        '<p class="h3">' + post.nickName + '</p>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="col-lg-9" style="border-left-width: 1px; border-left-style: solid; border-left-color: #dddddd;">' +
                                    '<div style="border-left-width: 5px; padding-left: 5px; border-left-style: solid; border-left-color: antiquewhite;">' +
                                        '<span>ç½—ä¼Ÿåœ¨ä»–çš„å¸–å­ä¸­æåˆ°ï¼š</span>' +
                                        '<div>' + toContent + '</div>' +
                                    '</div>' +
                                    '<div style="border-bottom: rebeccapurple solid 1px;">' + content + '</div>' +
                                        '<div>' +
                                            '<button type="button" class="btn reply-button" data-reply-id="' + post.id + '">' +
                                                '<span class="glyphicon glyphicon-edit" aria-hidden="true"></span>å›å¸–' +
                                            '</button>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>'
                        );
                    },
                    error: function (response) {
                        console.log(response);
                        alert("å¤±è´¥å“ˆå“ˆï¼");
                    }
                });
            });
        </script>
    </body>
</html>